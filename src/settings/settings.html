<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <style>
        @import url("../content/css/settings.css");
    </style>
    <title>GoofCord settings</title>
</head>
<body>
<p class="center">Some changes may require the app to restart before taking effect</p>
<h2>General settings</h2>
<form class="settingsContainer">
    <fieldset>
        <div class="checkbox-container">
            <input data-setting="minimizeToTray" id="minimizeToTray" type="checkbox"/>
            <label for="minimizeToTray">Minimize to tray</label>
        </div>
        <p class="description">
            When disabled, GoofCord will close like any other window when closed, otherwise, it'll sit back and
            relax in your system tray for later.
        </p>
    </fieldset>
    <fieldset>
        <div class="checkbox-container">
            <input data-setting="startMinimized" id="startMinimized" type="checkbox"/>
            <label for="startMinimized">Start minimized</label>
        </div>
        <p class="description">GoofCord starts in the background and remains out of your way.</p>
    </fieldset>
    <fieldset>
        <div class="checkbox-container">
            <input data-setting="dynamicIcon" id="dynamicIcon" type="checkbox"/>
            <label for="dynamicIcon">Dynamic icon</label>
        </div>
        <p class="description">
            Following Discord's behavior on Windows, this shows unread messages/pings count on GoofCord's icon
            instead of its tray. Overwrites the custom icon.
        </p>
    </fieldset>
    <fieldset>
        <div class="checkbox-container">
            <input class="text" data-setting="customIconPath" type="text"/>
            <label>Custom Icon Path</label>
        </div>
        <p class="description">
            Leave empty for the default icon. The path should conform to your OS's format. A Windows example: "D:/Downloads/icon.png". A Linux and macOS example: "/home/Downloads/icon.png".
        </p>
    </fieldset>
    <fieldset>
        <div class="checkbox-container">
            <input data-setting="launchWithOsBoot" id="launchWithOsBoot" type="checkbox"/>
            <label for="launchWithOsBoot">Launch with OS</label>
        </div>
        <p class="description">
            When enabled starts GoofCord on OS boot automatically.
        </p>
    </fieldset>
    <fieldset>
        <div class="checkbox-container">
            <input data-setting="multiInstance" id="multiInstance" type="checkbox"/>
            <label for="multiInstance">Multi Instance</label>
        </div>
        <p class="description">
            Experimental. When enabled, you'll be able to start up many instances of GoofCord. This is not tested
            properly though and may not do what you want.
        </p>
    </fieldset>
</form>

<h2>Client Mods settings</h2>
<form class="settingsContainer">
    <fieldset>
        <div class="checkbox-container">
            <select class="left dropdown" data-setting="modName" name="modName">
                <option value="none">None</option>
                <option selected value="vencord">Vencord</option>
                <option value="shelter">Shelter</option>
                <option value="custom">Custom</option>
            </select>
            <label> Client mod </label>
        </div>
        <p class="description">What client mod to use. Vencord is heavily recommended because much of GoofCords functionality depends on it.</p>
    </fieldset>
    <fieldset id="customMod" style="display: none">
        <div class="checkbox-container">
            <input class="text" data-setting="customJsBundle" type="text"/>
            <label> Custom JS bundle </label>
        </div>
        <br>
        <div class="checkbox-container">
            <input class="text" data-setting="customCssBundle" type="text"/>
            <label> Custom CSS bundle </label>
        </div>
        <p class="description">A raw link to the JS bundle and CSS bundle of a client mod you want to use. Placeholder
            css: "https://armcord.xyz/placeholder.css"</p>
    </fieldset>
</form>

<h2>Privacy settings</h2>
<form class="settingsContainer">
    <fieldset>
        <div class="checkbox-container">
            <textarea data-setting="blocklist"></textarea>
        </div>
        <p class="description">
            A list of URLs to block. Each entry must be separated by a comma.
        </p>
    </fieldset>
</form>

<h2><a target="_blank" href="https://github.com/Milkshiift/GoofCord/wiki/Script-Loader">Script loader</a> and scripts settings</h2>
<form class="settingsContainer">
    <fieldset>
        <div class="checkbox-container">
            <input data-setting="scriptLoading" id="scriptLoading" type="checkbox"/>
            <label for="scriptLoading">Script loading</label>
        </div>
        <p class="description">
            Enables script loader.
        </p>
    </fieldset>
    <fieldset>
        <div class="checkbox-container">
            <input data-setting="autoUpdateDefaultScripts" id="autoUpdateDefaultScripts" type="checkbox"/>
            <label for="autoUpdateDefaultScripts">Auto-update default scripts</label>
        </div>
        <p class="description">
            Enables auto-update for the <a target="_blank" href="https://github.com/Milkshiift/GoofCord-Scripts">default GoofCord scripts</a>.
        </p>
    </fieldset>
    <h2>Encryption settings</h2>
    <fieldset>
        <div class="checkbox-container">
            <div class="spoiler">
                <textarea data-setting="encryptionPasswords"></textarea>
            </div>
        </div>
        <p class="description">
            Securely stored, encrypted list of your passwords.
            A backup in a warm, safe place is recommended.
            Separate entries with commas.
        </p>
    </fieldset>
    <fieldset>
        <div class="checkbox-container">
            <input class="text" data-setting="encryptionCover" type="text"/>
            <label>Encryption Cover</label>
        </div>
        <p class="description">
            A message that a user without the password will see. Minimum two words or empty.
        </p>
    </fieldset>
    <fieldset>
        <div class="checkbox-container">
            <input class="text" data-setting="encryptionMark" type="text"/>
            <label>Encryption Mark</label>
        </div>
        <p class="description">
            A string that will be prepended to each decrypted message,
            so it's easier to differentiate what messages are encrypted.
        </p>
    </fieldset>
</form>

<h2>Other settings</h2>
<form class="settingsContainer">
    <fieldset>
        <div class="checkbox-container">
            <input data-setting="arrpc" id="arrpc" type="checkbox"/>
            <label for="arrpc">Activity display</label>
        </div>
        <p class="description">Enables the use of an <b>open source</b> reimplementation of Discord's
            rich presence called <a target="_blank" href="https://github.com/OpenAsar/arrpc">arRPC</a>.</p>
    </fieldset>
    <fieldset>
        <div class="checkbox-container">
            <input data-setting="spellcheck" id="spellcheck" type="checkbox"/>
            <label for="spellcheck">Spellcheck</label>
        </div>
        <p class="description">Whether to enable spellcheck for input fields or not.</p>
    </fieldset>
    <fieldset>
        <div class="checkbox-container">
            <input data-setting="updateNotification" id="updateNotification" type="checkbox"/>
            <label for="updateNotification">Update notification</label>
        </div>
        <p class="description">
            When a new version releases, every time you launch GoofCord, a notification will pop up telling you that an
            update is available.
            You can disable this behavior here. Pings github.com
        </p>
    </fieldset>
    <fieldset>
        <div class="checkbox-container">
            <input data-setting="disableAutogain" id="disableAutogain" type="checkbox"/>
            <label for="disableAutogain">Disable auto-gain</label>
        </div>
        <p class="description">
            Disable microphone auto-gain. It can be useful when your mic is quieter than it should be.
        </p>
    </fieldset>
    <fieldset>
        <div class="checkbox-container">
            <select class="left dropdown" data-setting="prfmMode" name="prfmMode">
                <option selected value="none">None</option>
                <option value="performance">Performance</option>
                <option value="battery">Battery</option>
            </select>
            <label> Performance mode </label>
        </div>
        <p class="description">
            Performance mode is an experimental feature that may either increase responsiveness and performance
            of GoofCord or… decrease it. Try every option and see which fits you the best.
        </p>
    </fieldset>
    <fieldset>
        <div class="checkbox-container">
            <input class="text" data-setting="discordUrl" type="text"/>
            <label>Discord URL</label>
        </div>
        <p class="description">
            URL of the discord. Variations: https://canary.discord.com/app, https://ptb.discord.com/app or
            https://discord.com/app
        </p>
    </fieldset>
</form>

<fieldset>
    <button class="center" data-open="Extensions" data-string="settings-extensionsFolder">Open extensions folder</button>
    <button class="center" data-open="Scripts" data-string="settings-scriptsFolder">Open scripts folder</button>
    <button class="center" data-open="Storage" data-string="settings-storageFolder">Open storage folder</button>
    <button
            class="center"
            data-string="settings-copyDebugInfo"
            id="settings-copyDebugInfo"
            onclick="settings.copyDebugInfo()"
    >
        Copy Debug Info
    </button>
    <button
            class="center"
            data-string="settings-forceNativeCrash"
            id="settings-forceNativeCrash"
            onclick="settings.crash()"
    >
        Force native crash
    </button>
</fieldset>
</body>
<script>
    // WARNING ⚠️ All code below may cause intense headaches. I won't fix it 😊.

    async function updateSettings() {
        const elements = document.querySelectorAll("[data-setting]");
        for (const e of elements) {
            try {
                let value = await settings.get(e.dataset.setting);
                if (e.dataset.setting === "encryptionPasswords") {
                    let decryptedPasswords = [];
                    for (const password in value) {
                        decryptedPasswords.push(await settings.decryptSafeStorage(value[password]));
                    }
                    value = decryptedPasswords;
                }
                handleSettingElement(e, value);
            } catch (error) {
                console.error(`Error fetching setting for element with dataset setting: ${e.dataset.setting}`, error);
            }
        }
    }

    function handleSettingElement(element, value) {
        const type = typeof value;
        if (type === "boolean") {
            if (element.tagName === "SELECT") {
                element.value = value;
                toggleCustomModDisplay(value);
            } else {
                element.checked = value;
            }
        } else if (type === "object") {
            element.value = value.join(",\n");
        } else if (type === "string") {
            element.value = value;
        }
    }

    function toggleCustomModDisplay(value) {
        const customMod = document.getElementById('customMod');
        customMod.style.display = value === 'custom' ? 'block' : 'none';
    }

    document.querySelectorAll("[data-open]").forEach((e) => {
        e.addEventListener("click", settings[`open${e.dataset.open}Folder`]);
    });

    const elements = document.querySelectorAll("[data-setting]");
    elements.forEach((element) => {
        element.addEventListener("change", async () => {
            await saveSettings();
            if (element.name === "modName") {
                toggleCustomModDisplay(element.value);
            }
        });
    });

    async function saveSettings() {
        const elements = Array.from(document.querySelectorAll("[data-setting]"));
        const obj = Object.fromEntries(
            elements.map((e) => [e.dataset.setting, e.tagName === "SELECT" || e.type === "text" ? e.value : e.checked])
        );
        for (const textarea of document.getElementsByTagName('textarea')) {
            const dataSetting = textarea.getAttribute('data-setting');
            let arrayFromTextArea = [];
            if (dataSetting === "encryptionPasswords") {
                arrayFromTextArea = await createArrayFromTextareaEncrypted(textarea);
            } else {
                arrayFromTextArea = createArrayFromTextarea(textarea);
            }
            obj[dataSetting] = arrayFromTextArea;
        }
        console.log(obj);
        settings.save(obj);
        settings.flashTitlebar("#5865F2");
    }

    function createArrayFromTextarea(input) {
        let inputValue = input.value.replace(/(\r\n|\n|\r|\s+)/gm, "");
        if (inputValue.endsWith(",")) {
            inputValue = inputValue.slice(0, -1);
        }
        return inputValue.split(",");
    }

    async function createArrayFromTextareaEncrypted(input) {
        let inputValue = input.value.replace(/(\r\n|\n|\r|\s+)/gm, "");
        if (inputValue.endsWith(",")) {
            inputValue = inputValue.slice(0, -1);
        }
        let encryptedPasswords = [];
        const arrayFromTextArea = inputValue.split(",");
        for (const password in arrayFromTextArea) {
            encryptedPasswords.push(await settings.encryptSafeStorage(arrayFromTextArea[password]));
        }
        return encryptedPasswords;
    }

    updateSettings();
</script>
</html>
