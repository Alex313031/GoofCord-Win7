<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <style>
            @import url("../content/css/settings.css");
        </style>
    </head>

    <body>
        <div class="saveBar">
            <button class="center" data-string="settings-save" onclick="saveSettings()">Save Settings</button>
        </div>

        <div class="restartBar">
            <button class="center" data-string="settings-restart" onclick="settings.restart()">Restart App</button>
        </div>

        <br />

        <div class="switch acTray">
            <label class="header" data-string="settings-tray">Minimize to tray</label>
            <input class="tgl tgl-light left" data-setting="minimizeToTray" id="tray" type="checkbox" />
            <label class="tgl-btn left" for="tray"></label>
            <p class="description" data-string="settings-tray-desc">When disabled, GoofCord will close like any other window when closed, otherwise it'll sit back and relax
                in your system tray for later.</p>
        </div>
        <br />

        <div class="switch acMinimized">
            <label class="header" data-string="settings-startMinimized">Start minimized</label>
            <input class="tgl tgl-light left" data-setting="startMinimized" id="startMinimized" type="checkbox" />
            <label class="tgl-btn left" for="startMinimized"></label>
            <p class="description" data-string="settings-startMinimized-desc">GoofCord starts in background and remains out of your way.</p>
        </div>
        <br />

        <div class="switch acDynamicIcon">
            <label class="header" data-string="settings-dynamicIcon">Dynamic icon</label>
            <input class="tgl tgl-light left" data-setting="dynamicIcon" id="dynamicIcon" type="checkbox" />
            <label class="tgl-btn left" for="dynamicIcon"></label>
            <p class="description" data-string="settings-dynamicIcon-desc">Following Discord's behaviour on Windows, this shows unread messages/pings count on GoofCord's icon instead of it's tray.</p>
        </div>
        <br />
        <br />

        <div class="switch acAdvSettings">
            <h1 class="center advancedText" data-string="settings-advanced">Advanced user zone</h1>
            <br />
            <div class="acWhitelist">
                <label class="header" data-string="settings-whitelist">Whitelist</label>
                <textarea class="text" data-setting="whitelist" id="whitelist" type="text"></textarea>
                <p class="description" data-string="settings-dynamicIcon-desc">If the request URL does not start with any URL in this list, it will be blocked. Each entry must be separated by a comma.</p>
            </div>
            <button class="center" data-open="Plugins" data-string="settings-pluginsFolder">Open plugins folder</button>
            <button class="center" data-open="Themes" data-string="settings-themesFolder">Open themes folder</button>
            <button class="center" data-open="Storage" data-string="settings-storageFolder">Open storage folder</button>
            <button class="center" data-open="Crashes" data-string="settings-crashesFolder">Open native crashes folder</button>
            <button
                class="center"
                data-string="settings-copyDebugInfo"
                id="settings-copyDebugInfo"
                onclick="settings.copyDebugInfo()"
            >Copy Debug Info</button>
            <br />
            <button
                class="center"
                data-string="settings-forceNativeCrash"
                id="settings-forceNativeCrash"
                onclick="settings.crash()"
            >Force native crash</button>
        </div>
    </body>

    <script>
        const elements = document.querySelectorAll("[data-setting]");
        elements.forEach(async (e) => {
            const value = await settings.get(e.dataset.setting);
            console.log(typeof value);
            if (typeof value == "boolean") {
                if (e.tagName === "SELECT") e.value = value;
                else e.checked = value;
            }
            else if (typeof value == "object") {
                e.value = value.join(",\n");
            }
        });

        function saveSettings() {
            const elements = Array.from(document.querySelectorAll("[data-setting]"));
            const obj = Object.fromEntries(
                elements.map((e) => [e.dataset.setting, e.tagName === "SELECT" ? e.value : e.checked])
            );
            const settingsObj = {
                ...obj, // Add the other settings to the object
                whitelist: createUrlArray() // Add the whitelist to the object
            };
            //console.log(settingsObj);
            settings.save(settingsObj);

            const doRestart = confirm(`Your settings have been saved!
Some changes may require the app to restart before taking effect, would you like to do so now?`);
            if (doRestart) settings.restart();
        }

        function createUrlArray() {
            let urlInput = document.getElementById("whitelist").value.replace(/\s/g, ''); // Remove all whitespace from input
            if (urlInput.endsWith(",")) { // Check if input ends with a comma
                urlInput = urlInput.slice(0, -1); // Remove the comma from the end of the input
            }
            let urls = urlInput.split(",");
            return(urls);
        }

        document.querySelectorAll("[data-open]").forEach((e) => {
            e.addEventListener("click", settings[`open${e.dataset.open}Folder`]);
        });
    </script>
</html>
